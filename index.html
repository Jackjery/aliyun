<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">

    <!-- ä¸»é¢˜ç³»ç»Ÿ -->
    <link rel="stylesheet" href="./public/css/themes.css">
    <link rel="stylesheet" href="./public/css/output.css">
    <link rel="stylesheet" href="./public/css/icons.css">

    <style>
        /* iframe å®¹å™¨æ ·å¼ */
        .iframe-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 50px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
            overflow: hidden;
            transition: height 0.3s ease;
        }

        /* adminé¡µé¢æ¨¡å¼ï¼šiframeå æ»¡å…¨å± */
        body.admin-mode .iframe-container {
            height: 100vh;
        }

        /* adminé¡µé¢æ¨¡å¼ï¼šéšè—ä¸»å¯¼èˆªæ  */
        body.admin-mode header {
            display: none;
        }

        .page-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .page-frame.active {
            display: block;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .nav-link {
            color: rgb(var(--text-secondary));
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            color: rgb(var(--color-primary));
        }

        .nav-link.active {
            color: rgb(var(--color-primary));
            font-weight: 500;
            border-bottom: 2px solid rgb(var(--color-primary));
        }

        /* éª¨æ¶å±æ ·å¼ */
        #iframe-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(var(--bg-primary));
            z-index: 10;
            display: none;
            transition: opacity 0.3s ease;
        }

        #iframe-skeleton.show {
            display: block;
            opacity: 1;
        }

        #iframe-skeleton.hide {
            opacity: 0;
        }

        /* éª¨æ¶å±åŠ¨ç”» */
        @keyframes skeleton-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .skeleton-animate {
            animation: skeleton-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .skeleton-box {
            background: linear-gradient(90deg,
                rgba(var(--text-secondary), 0.1) 25%,
                rgba(var(--text-secondary), 0.15) 50%,
                rgba(var(--text-secondary), 0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 2s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>
<body style="background-color: rgb(var(--bg-primary)); min-height: 100vh; margin: 0; padding: 0;">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-card border-b border-default" style="height: 50px;">
        <div class="container mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <svg class="icon icon-xl text-primary" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                </svg>
                <h1 class="text-xl font-bold text-primary">å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°</h1>
            </div>

            <!-- å¯¼èˆªèœå• -->
            <nav class="hidden md:flex items-center space-x-6">
                <a class="nav-link active px-1 py-2" data-page="dashboard">é¦–é¡µ</a>
                <a class="nav-link px-1 py-2" data-page="trend">æ•°æ®è¶‹åŠ¿åˆ†æ</a>
                <a class="nav-link px-1 py-2" data-page="distribution">æ•°æ®åˆ†å¸ƒç»Ÿè®¡</a>
                <a class="nav-link px-1 py-2" data-page="warning">åœˆæ¬¡æ•°æ®é¢„è­¦</a>
                <a class="nav-link px-1 py-2" data-page="admin">
                    <svg class="icon mr-1 inline-block" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                    </svg>
                    æ•°æ®ç®¡ç†
                </a>
            </nav>

            <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
            <button class="md:hidden text-gray-600 hover:text-primary">
                <svg class="icon icon-xl" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- iframe å®¹å™¨ -->
    <div class="iframe-container">
        <!-- éª¨æ¶å± -->
        <div id="iframe-skeleton">
            <div class="container mx-auto px-4 py-6 h-full overflow-auto">
                <!-- å¤´éƒ¨éª¨æ¶ -->
                <div class="flex justify-between items-center mb-6">
                    <div class="h-8 w-48 skeleton-box"></div>
                    <div class="h-10 w-32 skeleton-box"></div>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡éª¨æ¶ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-card p-4 rounded shadow h-24">
                        <div class="h-4 w-20 skeleton-box mb-2"></div>
                        <div class="h-8 w-16 skeleton-box"></div>
                    </div>
                    <div class="bg-card p-4 rounded shadow h-24">
                        <div class="h-4 w-20 skeleton-box mb-2"></div>
                        <div class="h-8 w-16 skeleton-box"></div>
                    </div>
                    <div class="bg-card p-4 rounded shadow h-24">
                        <div class="h-4 w-20 skeleton-box mb-2"></div>
                        <div class="h-8 w-16 skeleton-box"></div>
                    </div>
                    <div class="bg-card p-4 rounded shadow h-24">
                        <div class="h-4 w-20 skeleton-box mb-2"></div>
                        <div class="h-8 w-16 skeleton-box"></div>
                    </div>
                </div>

                <!-- ä¸»è¦å†…å®¹åŒºéª¨æ¶ -->
                <div class="bg-card p-6 rounded shadow mb-6">
                    <div class="h-6 w-32 skeleton-box mb-4"></div>
                    <div class="h-80 skeleton-box"></div>
                </div>

                <!-- åŠ è½½æç¤º -->
                <div class="text-center">
                    <div class="inline-flex items-center" style="color: rgb(var(--color-primary));">
                        <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="font-medium">æ­£åœ¨åŠ è½½é¡µé¢...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¦–é¡µ iframe -->
        <iframe id="frame-dashboard" class="page-frame active" src="pages/dashboard.html"></iframe>

        <!-- è¶‹åŠ¿åˆ†æ iframe -->
        <iframe id="frame-trend" class="page-frame" data-src="pages/trend-analysis.html"></iframe>

        <!-- æ•°æ®åˆ†å¸ƒç»Ÿè®¡ iframe -->
        <iframe id="frame-distribution" class="page-frame" data-src="pages/data-distribution.html"></iframe>

        <!-- åœˆæ¬¡æ•°æ®é¢„è­¦ iframe -->
        <iframe id="frame-warning" class="page-frame" data-src="pages/circle-warning.html"></iframe>

        <!-- æ•°æ®ç®¡ç† iframe -->
        <iframe id="frame-admin" class="page-frame" data-src="pages/admin.html"></iframe>
    </div>

    <!-- æ ¸å¿ƒè„šæœ¬ - ä¸»é¢˜ç®¡ç†å™¨å’ŒçŠ¶æ€ç®¡ç†å™¨ -->
    <script src="./public/js/common/config.js"></script>
    <script src="./public/js/common/state-manager.js"></script>
    <script src="./public/js/common/theme-manager.js"></script>

    <script>
        // ç¡®ä¿ä¸»é¢˜ç®¡ç†å™¨åœ¨ index.html æ­£ç¡®åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // å¦‚æœä¸»é¢˜ç®¡ç†å™¨è¿˜æ²¡åˆå§‹åŒ–ï¼Œæ‰‹åŠ¨åˆå§‹åŒ–
            if (!window.themeManager) {
                console.log('ğŸ¨ æ‰‹åŠ¨åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨ï¼ˆindex.htmlï¼‰');
                window.themeManager = new ThemeManager();
            }

            // ç›‘å¬ iframe åŠ è½½å®Œæˆï¼Œåº”ç”¨ä¸»é¢˜
            document.querySelectorAll('iframe.page-frame').forEach(iframe => {
                iframe.addEventListener('load', () => {
                    if (window.themeManager) {
                        setTimeout(() => {
                            window.themeManager.applyThemeToIframes();
                            console.log(`ğŸ¨ å·²åº”ç”¨ä¸»é¢˜åˆ° iframe: ${iframe.id}`);
                        }, 100);
                    }
                });
            });
        });

        /**
         * SPA é¡µé¢åˆ‡æ¢æ§åˆ¶å™¨ï¼ˆiframe ç‰ˆæœ¬ï¼‰
         */
        class SPAController {
            constructor() {
                this.currentPage = 'dashboard';
                this.loadedFrames = new Set(['dashboard']); // é¦–é¡µå·²åŠ è½½
                this.skeleton = document.getElementById('iframe-skeleton');
                this.init();
            }

            init() {
                console.log('ğŸš€ SPA æ§åˆ¶å™¨åˆå§‹åŒ–...');

                // ç»‘å®šå¯¼èˆªç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.getAttribute('data-page');
                        this.navigateTo(page);
                    });
                });

                // ç›‘å¬æµè§ˆå™¨å‰è¿›/åé€€
                window.addEventListener('popstate', (e) => {
                    const page = e.state?.page || 'dashboard';
                    this.navigateTo(page, false);
                });

                // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
                window.addEventListener('message', (event) => {
                    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ¶ˆæ¯æ¥è‡ªåŒæº
                    if (event.origin !== window.location.origin) return;

                    // å¤„ç†é¡µé¢å°±ç»ªæ¶ˆæ¯
                    if (event.data && event.data.type === 'pageReady') {
                        const page = event.data.page;
                        console.log(`âœ… æ”¶åˆ°é¡µé¢å°±ç»ªæ¶ˆæ¯: ${page}`);

                        // å¦‚æœæ˜¯å½“å‰é¡µé¢ï¼Œéšè—éª¨æ¶å±
                        if (page === this.currentPage) {
                            this.hideSkeleton();
                        }
                    }
                });

                // æ£€æŸ¥ URL hashï¼Œå†³å®šåˆå§‹æ˜¾ç¤ºå“ªä¸ªé¡µé¢
                const hash = window.location.hash.slice(1); // å»æ‰ # å·
                const initialPage = hash || 'dashboard';

                if (initialPage !== 'dashboard') {
                    // å¦‚æœä¸æ˜¯é¦–é¡µï¼Œéœ€è¦å…ˆå¯¼èˆªè¿‡å»
                    this.navigateTo(initialPage, false);
                } else {
                    // å¦‚æœæ˜¯é¦–é¡µ dashboardï¼Œæ˜¾ç¤ºéª¨æ¶å±å¹¶ç­‰å¾…å°±ç»ªæ¶ˆæ¯
                    this.showSkeleton();
                    // ç­‰å¾… dashboard iframe åŠ è½½å®Œæˆåè¯¢é—®
                    const dashboardFrame = document.getElementById('frame-dashboard');
                    if (dashboardFrame) {
                        if (dashboardFrame.contentWindow && dashboardFrame.contentDocument && dashboardFrame.contentDocument.readyState === 'complete') {
                            // iframe å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥è¯¢é—®
                            setTimeout(() => {
                                dashboardFrame.contentWindow.postMessage({
                                    type: 'requestPageReady',
                                    page: 'dashboard'
                                }, window.location.origin);
                            }, 100);
                        } else {
                            // iframe è¿˜åœ¨åŠ è½½ï¼Œç›‘å¬ load äº‹ä»¶
                            dashboardFrame.addEventListener('load', () => {
                                setTimeout(() => {
                                    dashboardFrame.contentWindow.postMessage({
                                        type: 'requestPageReady',
                                        page: 'dashboard'
                                    }, window.location.origin);
                                }, 100);
                            }, { once: true });
                        }
                    }
                }

                // åˆå§‹åŒ–æµè§ˆå™¨å†å²è®°å½•
                window.history.replaceState({ page: initialPage }, '', `#${initialPage}`);

                console.log('âœ… SPA æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆï¼Œåˆå§‹é¡µé¢:', initialPage);
            }

            /**
             * æ˜¾ç¤ºéª¨æ¶å±
             */
            showSkeleton() {
                if (this.skeleton) {
                    this.skeleton.classList.remove('hide');
                    this.skeleton.classList.add('show');
                    console.log('ğŸ­ æ˜¾ç¤ºéª¨æ¶å±');
                }
            }

            /**
             * éšè—éª¨æ¶å±
             */
            hideSkeleton() {
                if (this.skeleton) {
                    this.skeleton.classList.remove('show');
                    this.skeleton.classList.add('hide');
                    // ç­‰å¾…åŠ¨ç”»å®Œæˆåå®Œå…¨éšè—
                    setTimeout(() => {
                        this.skeleton.classList.remove('hide');
                    }, 300);
                    console.log('ğŸ­ éšè—éª¨æ¶å±');
                }
            }

            /**
             * å¯¼èˆªåˆ°æŒ‡å®šé¡µé¢
             * @param {string} page - é¡µé¢åç§° (dashboard/trend/admin)
             * @param {boolean} pushState - æ˜¯å¦æ¨å…¥å†å²è®°å½•
             */
            navigateTo(page, pushState = true) {
                if (page === this.currentPage) return;

                // ğŸ” å¯¼èˆªå®ˆå«ï¼šè®¿é—®adminé¡µé¢éœ€è¦éªŒè¯token
                if (page === 'admin') {
                    const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                    if (!token) {
                        console.warn('âš ï¸ è®¿é—®adminé¡µé¢éœ€è¦ç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ');
                        window.location.href = 'pages/login.html';
                        return;
                    }
                }

                console.log(`ğŸ”€ é¡µé¢åˆ‡æ¢: ${this.currentPage} â†’ ${page}`);

                // æ˜¾ç¤ºéª¨æ¶å±
                this.showSkeleton();

                // éšè—å½“å‰é¡µé¢
                const currentFrame = document.getElementById(`frame-${this.currentPage}`);
                if (currentFrame) {
                    currentFrame.classList.remove('active');
                }

                // æ‡’åŠ è½½ iframe
                const targetFrame = document.getElementById(`frame-${page}`);
                if (targetFrame && !this.loadedFrames.has(page)) {
                    const src = targetFrame.getAttribute('data-src');
                    if (src) {
                        console.log(`ğŸ“„ åŠ è½½é¡µé¢: ${src}`);
                        targetFrame.src = src;
                        this.loadedFrames.add(page);

                        // ç›‘å¬ iframe åŠ è½½å®Œæˆ
                        targetFrame.addEventListener('load', () => {
                            console.log(`âœ… iframe HTML åŠ è½½å®Œæˆ: ${page}ï¼Œç­‰å¾…é¡µé¢åˆå§‹åŒ–...`);

                            // åº”ç”¨ä¸»é¢˜åˆ°æ–°åŠ è½½çš„ iframe
                            if (window.themeManager) {
                                setTimeout(() => {
                                    window.themeManager.applyThemeToIframes();
                                    console.log(`ğŸ¨ å·²åº”ç”¨ä¸»é¢˜åˆ°æ–°åŠ è½½çš„ iframe: ${page}`);
                                }, 100);
                            }
                            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œéšè—éª¨æ¶å±ï¼Œç­‰å¾… iframe å‘é€ pageReady æ¶ˆæ¯
                        }, { once: true });
                    }
                } else if (targetFrame) {
                    // é¡µé¢å·²åŠ è½½è¿‡ï¼Œä¸»åŠ¨è¯¢é—®æ˜¯å¦å°±ç»ª
                    console.log(`ğŸ“¤ è¯¢é—®å·²åŠ è½½é¡µé¢æ˜¯å¦å°±ç»ª: ${page}`);
                    setTimeout(() => {
                        try {
                            targetFrame.contentWindow.postMessage({
                                type: 'requestPageReady',
                                page: page
                            }, window.location.origin);
                        } catch (e) {
                            console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', e);
                            // å¦‚æœå‘é€å¤±è´¥ï¼Œ3ç§’åè‡ªåŠ¨éšè—éª¨æ¶å±
                            setTimeout(() => this.hideSkeleton(), 3000);
                        }
                    }, 100);
                }

                // æ˜¾ç¤ºç›®æ ‡é¡µé¢
                if (targetFrame) {
                    targetFrame.classList.add('active');
                }

                // æ›´æ–°å¯¼èˆªæ é«˜äº®
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.getAttribute('data-page') === page) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });

                // æ›´æ–°æµè§ˆå™¨å†å²è®°å½•
                if (pushState) {
                    window.history.pushState({ page }, '', `#${page}`);
                }

                // æ›´æ–°é¡µé¢æ ‡é¢˜
                const titles = {
                    'dashboard': 'å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°',
                    'trend': 'æ•°æ®è¶‹åŠ¿åˆ†æ - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°',
                    'distribution': 'æ•°æ®åˆ†å¸ƒç»Ÿè®¡ - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°',
                    'warning': 'åœˆæ¬¡æ•°æ®é¢„è­¦ - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°',
                    'admin': 'æ•°æ®ç®¡ç† - å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°'
                };
                document.title = titles[page] || 'å«æ˜Ÿä»»åŠ¡æ•°æ®åˆ†æå¹³å°';

                // adminé¡µé¢ï¼šå¯ç”¨å…¨å±æ¨¡å¼ï¼ˆéšè—ä¸»å¯¼èˆªï¼‰
                if (page === 'admin') {
                    document.body.classList.add('admin-mode');
                    console.log('âœ… å¯ç”¨adminå…¨å±æ¨¡å¼');
                } else {
                    document.body.classList.remove('admin-mode');
                    console.log('âœ… æ¢å¤æ­£å¸¸å¯¼èˆªæ¨¡å¼');
                }

                this.currentPage = page;
            }

            /**
             * è·å–å½“å‰é¡µé¢
             */
            getCurrentPage() {
                return this.currentPage;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.spaController = new SPAController();
            console.log('âœ… SPA æ§åˆ¶å™¨å·²åˆå§‹åŒ–');
            console.log('ğŸ’¡ æç¤ºï¼šä¸»é¢˜ç”±å„ iframe çš„ iframe-helper.js è‡ªåŠ¨åº”ç”¨');
        });

        // å…¨å±€å¿«æ·é”®æ”¯æŒï¼ˆå¯é€‰ï¼‰
        document.addEventListener('keydown', (e) => {
            // Alt + 1/2/3/4/5 å¿«é€Ÿåˆ‡æ¢é¡µé¢
            if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                const pageMap = {
                    '1': 'dashboard',
                    '2': 'trend',
                    '3': 'distribution',
                    '4': 'warning',
                    '5': 'admin'
                };
                const page = pageMap[e.key];
                if (page && window.spaController) {
                    e.preventDefault();
                    window.spaController.navigateTo(page);
                }
            }
        });
    </script>
</body>
</html>
